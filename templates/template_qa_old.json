{
  "min_packer_version" : "0.12.0",

    "builders": [
      {
        "type": "amazon-ebs",

        "access_key" : "{{user `AWS_ACCESS_KEY_ID`}}",
        "secret_key" : "{{user `AWS_SECRET_KEY`}}",

        "region": "{{user `region`}}",
        "vpc_id" : "{{user `vpc`}}",
        "availability_zone" : "{{user `availability_zone`}}",
        "subnet_id" : "{{user `subnet`}}",
        "security_group_id" : "{{user `security_group`}}",
        "associate_public_ip_address" : false,

        "ami_name": "Windows-AP-GOLD-{{isotime \"2006-01-02\"}}",
        "source_ami" :  "",
        "source_ami_filter": {
          "filters": {
            "virtualization-type": "hvm",
            "name": "*Windows_Server-2012-R2_RTM-English-64Bit-Base-*",
            "root-device-type": "ebs"
          },
          "owners": ["801119661308"],
          "most_recent": true
        },

        "instance_type": "t2.large",
        "temporary_key_pair_name" : "{{user `temporary_key_pair_name`}}",
        "launch_block_device_mappings"  : [
          {
              "device_name" : "/dev/sda1",
              "volume_size" : 50,
              "volume_type" : "gp2",
              "delete_on_termination" : true
          }
        ],

        "communicator" : "winrm",
        "winrm_port"  : 5986,
        "winrm_username" : "Administrator",
        "winrm_timeout" : "1h",
        "winrm_use_ssl" : true,
        "winrm_insecure"  : true,

        "ssh_keypair_name"  : "GIWindowsAMI_QA",
        "ssh_private_key_file"  : "keys/GIWindowsAMI_QA.pem",

        "user_data_file" : "userdata/userdata.txt",
        "windows_password_timeout" : "20m",

        "ami_description" : "Windows 2012 R2 Server pre-baked AMI build",

        "run_tags"  : {
          "Name" : "Windows-AP-GOLD-{{isotime \"2006-01-02\"}}",
          "Cost Center" : "N/A",
          "Customer Facing" : "No",
          "Environment" : "QA",
          "Role" : "AMI",
          "Service" : "EC2",
          "Support Team" : "techgssserver@ap.org",
          "OS" : "Windows 2012 R2 STD"
        },

        "tags"  : {
          "Name" : "Windows-AP-GOLD-{{isotime \"2006-01-02\"}}",
          "Cost Center" : "N/A",
          "Customer Facing" : "No",
          "Environment" : "QA",
          "Role" : "AMI",
          "Service" : "AMI",
          "Support Team" : "techgssserver@ap.org",
          "OS" : "Windows 2012 R2 STD"
        },

        "ami_regions" : [
            "us-west-2",
            "eu-west-1"
        ],

        "ami_users" : [
          "720322524327",
          "838870929816",
          "222259241209",
          "557187967306",
          "576439789282",
          "959162376654",
          "656041960331",
          "198401342403",
          "134056038641",
          "903501326418",
          "185351644654",
          "201356851952",
          "304498741827",
          "882018314208",
          "462561078695",
          "699694540698"
        ]
      }
  ],

  "_comment"  : "Provision Section",
  "provisioners" : [
    {
      "type"  : "powershell",
      "inline"  : [
        "New-Item -Path C:\\apps -ItemType Directory -Force",
        "New-Item -Path C:\\spec -ItemType Directory -Force",
        "New-Item -Path C:\\opt -ItemType Directory -Force",
        "New-Item -Path C:\\opt\\sensu -ItemType Directory -Force",
        "New-Item -Path C:\\opt\\sensu\\conf.d -ItemType Directory -Force"
      ]
    },
    {
      "type"  : "file",
      "source"  : "scripts/client.json",
      "destination" : "C:\\opt\\sensu\\conf.d\\client.json"
    },
    {
      "type"  : "file",
      "source"  : "scripts/sensu-client.xml",
      "destination" : "C:\\apps\\sensu-client.xml"
    },
    {
      "type"  : "file",
      "source"  : "scripts/gem-serverspec.bat",
      "destination" : "C:\\apps\\gem-serverspec.bat"
    },
    {
      "type"  : "file",
      "source"  : "scripts/win_spec.rb",
      "destination" : "C:\\spec\\win_spec.rb"
    },
    {
      "type"  : "file",
      "source"  : "scripts/winupdates.ps1",
      "destination" : "C:\\Windows\\Temp\\winupdates.ps1"
    },
    {
      "type" : "powershell",
      "scripts" : [
          "scripts/copyapps2.ps1",
          "scripts/cleanup.ps1",
          "scripts/prepare.ps1"
      ],
      "start_retry_timeout" : "20m"
    },
    {
      "type" : "windows-shell",
      "script"  : "scripts/spec_test.bat"
    },
    {
      "type" : "powershell",
      "script" :  "scripts/Sysprep.ps1"
    }
  ]
}
